# Use a lightweight Ubuntu base image
FROM ubuntu:22.04

# Set environment variables to prevent interactive prompts during apt installs
ENV DEBIAN_FRONTEND=noninteractive

# Install necessary packages:
# git: for cloning repositories
# build-essential: includes g++ and make for C/C++ compilation
# ca-certificates: SSL certificates for HTTPS connections
# python3: Python 3 interpreter
# python3-pip: Python package manager
RUN apt-get update && apt-get install -y \
    git \
    net-tools \
    build-essential \
    ca-certificates \
    python3 \
    python3-pip && \
    pip3 install --no-cache-dir pyyaml jinja2 requests psutil pandas matplotlib ccxt && \
    rm -rf /var/lib/apt/lists/*

# Create symbolic link for python command
RUN ln -s /usr/bin/python3 /usr/bin/python

# Verify installations
RUN git --version && \
    g++ --version && \
    make --version && \
    python3 --version && \
    pip3 --version && \
    python3 -c "import yaml; print('PyYAML version:', yaml.__version__)"

# Set the working directory
WORKDIR /app

# ğŸ”¥ Clone the TradeSystem repository
RUN git clone https://github.com/Celia2024-bit/TradeSystem.git

# ğŸ”¥ Change to the repository directory
WORKDIR /app/TradeSystem

# 1. å¼ºåˆ¶æ‰“ç ´ç¼“å­˜å¹¶æ‹‰å–ä¸»ä»“åº“æœ€æ–°ä»£ç 
# è¿™é‡Œçš„ random é“¾æ¥æ˜¯ä¸ºäº†ç¡®ä¿æ¯æ¬¡ build éƒ½ä¼šæ‰§è¡Œè¿™ä¸€æ­¥ï¼Œè€Œä¸ä½¿ç”¨ç¼“å­˜
ADD "https://www.random.org/cgi-bin/randbyte?nbytes=10&format=h" skipcache
RUN git pull origin master 

# 2. å…³é”®ï¼šåŒæ­¥å¹¶æ›´æ–°å­æ¨¡å—åˆ°æœ€æ–°çŠ¶æ€
# --init ç¡®ä¿å¦‚æœç›®å½•æ²¡åˆå§‹åŒ–å°±åˆå§‹åŒ–ï¼Œ--recursive å¤„ç†åµŒå¥—å­æ¨¡å—
RUN git submodule sync --recursive && \
    git submodule update --init --recursive

# 3. æ‰“å°ç¡®è®¤æ–‡ä»¶æ˜¯å¦å­˜åœ¨ (è°ƒè¯•ç”¨)
RUN ls -la tools/performance_monitor/requirements.txt

# 4. æ‰§è¡Œå®‰è£…
WORKDIR /app/TradeSystem/tools/performance_monitor
RUN pip3 install --no-cache-dir -r requirements.txt

# ğŸ”¥ Expose the port that FastAPI will run on
EXPOSE 8080



# ç¡®ä¿äº¤æ˜“ç³»ç»Ÿçš„ output ç›®å½•æœ‰æ‰§è¡Œæƒé™
RUN mkdir -p /app/TradeSystem/output && chmod -R 777 /app/TradeSystem

# å¯åŠ¨è„šæœ¬æ”¹è¿›ï¼š
# ä½¿ç”¨ 0.0.0.0 æ‰èƒ½è®©å®¹å™¨å¤–çš„è¯·æ±‚è¿›å…¥
CMD ["python3", "-m", "uvicorn", "server_main.py:app", "--host", "0.0.0.0", "--port", "8080"]